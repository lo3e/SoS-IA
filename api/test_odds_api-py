# src/test_odds_recent.py
import os
import requests
from dotenv import load_dotenv
import json

load_dotenv()
API_KEY = os.getenv("API_FOOTBALL_KEY")
BASE_URL = "https://v3.football.api-sports.io"
HEADERS = {"x-apisports-key": API_KEY}

# Serie A ID = 135
LEAGUE_ID = 135

def get_recent_fixtures():
    """Ottiene partite recenti e future (limitiamoci a 5 per test)."""
    url = f"{BASE_URL}/fixtures?league={LEAGUE_ID}&season=2025&next=5"
    r = requests.get(url, headers=HEADERS)
    r.raise_for_status()
    data = r.json().get("response", [])
    fixtures = [
        {
            "fixture_id": f["fixture"]["id"],
            "date": f["fixture"]["date"],
            "home": f["teams"]["home"]["name"],
            "away": f["teams"]["away"]["name"],
        }
        for f in data
    ]
    return fixtures

def get_odds_for_fixture(fixture_id):
    """Scarica le quote per una singola partita."""
    url = f"{BASE_URL}/odds?fixture={fixture_id}"
    r = requests.get(url, headers=HEADERS)
    r.raise_for_status()
    return r.json().get("response", [])

def main():
    fixtures = get_recent_fixtures()
    print(f"üìÖ Trovate {len(fixtures)} partite prossime:\n")
    for f in fixtures:
        print(f"- {f['home']} vs {f['away']} ({f['date']}) id={f['fixture_id']}")

    if fixtures:
        sample = fixtures[0]
        print(f"\nüéØ Estraggo quote per {sample['home']} - {sample['away']}...")
        odds = get_odds_for_fixture(sample["fixture_id"])

        if not odds:
            print("‚ö†Ô∏è Nessuna quota trovata per questa partita.")
            return

        first = odds[0]
        print("\n‚úÖ Dati disponibili! Chiavi principali:")
        print(json.dumps({k: type(v).__name__ for k, v in first.items()}, indent=2))

        bookmakers = first.get("bookmakers", [])
        print(f"\nüè¶ Bookmaker trovati: {len(bookmakers)}")

        for b in bookmakers[:3]:  # Mostra solo i primi 3
            # Analizziamo la struttura reale
            print(f"\nüß± Struttura bookmaker:")
            print(json.dumps({k: type(v).__name__ for k, v in b.items()}, indent=2))

            # Prova a leggere i dati principali
            name = b.get("bookmaker", {}).get("name") or b.get("name") or "Sconosciuto"
            print(f"  - {name}")

            bets = b.get("bets", [])
            print(f"    ‚Ä¢ {len(bets)} mercati trovati")

            for bet in bets[:2]:
                print(f"      ‚ñ™ Mercato: {bet.get('name')}")
                for value in bet.get("values", [])[:3]:
                    print(f"        ‚Ü≥ {value.get('value')} : {value.get('odd')}")


if __name__ == "__main__":
    main()
